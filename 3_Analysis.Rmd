---
title: "3_Analysis"
output: html_document
---

```{r, message = F, warning = F}
## Startup
rm(list = ls())
library(easypackages)
libraries("tidyverse", "metafor", "magrittr", "knitr")


## Load Data
df <- readRDS("C:\\Users\\isaac\\Google Drive\\Research\\Projects\\Body Dissatisfaction Meta-Analysis\\BD-depression-meta-analysis\\Data\\Data With Effect Sizes.rds")


## Prepare Follow-up Data
#Reshape to long dataset, code for follow-up time-point, and keep only follow-up outcomes
df.fu <- df %>%
        select_at(vars(-matches(".post"))) %>%
        pivot_longer(cols = time.fu1:varG.fu2_t2,
                     names_to = c("var", "followUp"),
                     names_sep = "\\.") %>%
        mutate(var = if_else(var %in% c("d", "varD", "g", "varG"),
                             paste0(var, ".fu", gsub(".*(?=_)", "", followUp, perl = T)),
                             var),
               followUp = gsub("_.*", "", followUp)) %>%
        pivot_wider(names_from = "var",
                    values_from = "value") %>%
        drop_na(time) %>%
        mutate(effectLabel = paste0(effectLabel, " (", time, " weeks)"))
```

# Meta-analysis

Mixed-effects model with robust variance estimation using `metafor`

Reference: <https://www.metafor-project.org/doku.php/analyses>

Documentation: <https://www.rdocumentation.org/packages/metafor/versions/2.4-0/topics/rma.mv> _(see for ANOVA/Wald tests)_

## Post-test effects

### Intercept-only model

#### POST-TEST DATA ONLY

```{r}
model.post.IO_t2 <- rma.mv(yi = g.post_t2 ~ 1,
                           V = varG.post_t2,
                           random = ~ 1 | studyID,
                           data = df) %>%
  robust(cluster = df$studyID)

print(model.post.IO_t2)
```

Default forest plot

```{r}
forest(model.post.IO_t2,
       slab = df$article,
       order = order(df$article))
```

My forest plot

```{r}
out <- df %>%
  mutate(est = g.post_t2,
         lower = g.post_t2 - (1.96 * sqrt(varG.post_t2)),
         upper = g.post_t2 + (1.96 * sqrt(varG.post_t2))) %>%
  select(article, effectLabel, est, lower, upper)

out <- rbind(out,
             tibble(
               article = NA,
               effectLabel = "Overall Estimate",
               est = model.post.IO_t2$b[1,1],
               lower = model.post.IO_t2$ci.lb,
               upper = model.post.IO_t2$ci.ub
             ))

ggplot(out, 
       aes(y = effectLabel, 
           x = est,
           xmin = lower,
           xmax = upper)) +
  geom_point() +
  geom_errorbarh() +
  scale_y_discrete(name = NULL) + #Set breaks = NULL to remove effect labels
  scale_x_continuous(name = "Hedge's g") +
  facet_grid(article ~ .,
             scales = "free_y",
             space = "free_y",
             switch = "y") +
  theme(strip.placement = "outside",
        strip.text.y.left = element_text(angle = 0),
        panel.background = element_rect(fill = NA),
        axis.line.x = element_line(size = .5, color = "black"),
        axis.ticks.y.left = element_blank()) +
  geom_vline(xintercept = 0, linetype = 2)
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.post.IO_t1t2 <- rma.mv(yi = g.post_t1t2 ~ 1,
                             V = varG.post_t1t2,
                             random = ~ 1 | studyID,
                             data = df) %>%
  robust(cluster = df$studyID)

print(model.post.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

***Include levels with < 3 studies in the overall moderator test?***

```{r}
moderators <- c("year", "pubStatus", "country", "sampleSource", "meanAge", "pctFemale", "pctNonwhite", "interventionType", "riskScreen", "outcome", "controlCond", "deliveryFormat", "target", "provider", "supervision", "length.minutes", "length.sessions", "length.days", "trtCompletion", "studyCompletion")
#also interventionParticipant, meanType
#no pctSexualMinotiry; all NA
#no respondent; all youth-reported
#no preTraining; all featured training or NA

out <- tibble(
  moderator = NA_character_,
  level = NA_character_,
  nStudies = NA_real_,
  nES = NA_real_,
  subgroupEst = NA_real_,
  subgroupP = NA_real_,
  overallStat = NA_real_,
  overallP = NA_real_
)

#Temporary workaround for weird error
df$deliveryFormat[df$deliveryFormat=="Other"] <- NA

for(moderator in moderators) {
  
  class <- class(df[[moderator]])
  
  temp <- rma.mv(as.formula(paste0("yi = g.post_t2 ~ 1 + ", moderator)),
                 V = varG.post_t2,
                 random = ~ 1 | studyID,
                 data = df[!is.na(df[[moderator]]),]) %>%
    robust(cluster = df$studyID[!is.na(df[[moderator]])])
    
  modTest <- anova.rma(temp)
    
  test = modTest$test
  type = modTest$type
  dfs = modTest$dfs
  stat = modTest$QM
  p = modTest$QMp
  
  if(class == "numeric") {
    
    nStudies = length(unique(df$studyID[!is.na(df[[moderator]])]))
    nES = sum(!is.na(df[[moderator]]))
    
    out <- rbind(out, tibble(
      moderator = moderator,
      level = NA,
      nStudies = nStudies,
      nES = nES,
      subgroupEst = NA,
      subgroupP = NA,
      overallStat = stat,
      overallP = p
    ))
  
  }
  
  if(class == "character") {
    
    levels <- unique(df[[moderator]])
    
    out <- rbind(out, tibble(
      moderator = moderator,
      level = NA,
      nStudies = NA,
      nES = NA,
      subgroupEst = NA,
      subgroupP = NA,
      overallStat = stat,
      overallP = p
    ))
    
    for(level in levels) {
      
      nStudies = length(unique(df$studyID[df[[moderator]] %in% level]))
      nES = sum(df[[moderator]] %in% level)
    
      if(nStudies >= 3) {
        
          temp <- rma.mv(yi = g.post_t2 ~ 1,
                 V = varG.post_t2,
                 random = ~ 1 | studyID,
                 data = df[df[[moderator]] %in% level,]) %>%
            robust(cluster = df$studyID[df[[moderator]] %in% level])
          
          subgroupEst = temp$b[[1]]
          subgroupP = temp$pval
          
          out <- rbind(out, tibble(
            moderator = moderator,
            level = level,
            nStudies = nStudies,
            nES = nES,
            subgroupEst = subgroupEst,
            subgroupP = subgroupP,
            overallStat = NA,
            overallP = NA
          ))
          
      } else if(nStudies < 3) {
        
          out <- rbind(out, tibble(
            moderator = moderator,
            level = level,
            nStudies = nStudies,
            nES = nES,
            subgroupEst = NA,
            subgroupP = NA,
            overallStat = NA,
            overallP = NA
          ))
        
      }
      
    }
    
  }
  
}

out <- out[-1,]

options(knitr.kable.NA = "")
kable(out, digits = 2)
```

_End of post-test effects analysis._

## Follow-up effects

### Intercept-only model

#### FOLLOW-UP DATA ONLY

```{r}
model.fu.IO_t2 <- rma.mv(yi = g.fu_t2 ~ 1,
                         V = varG.fu_t2,
                         random = ~ 1 | studyID,
                         data = df.fu) %>%
  robust(cluster = df.fu$studyID)

print(model.fu.IO_t2)
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.fu.IO_t1t2 <- rma.mv(yi = g.fu_t1t2 ~ 1,
                           V = varG.fu_t1t2,
                           random = ~ 1 | studyID,
                           data = df.fu) %>%
  robust(cluster = df.fu$studyID)

print(model.fu.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

```{r}

```

_End of follow-up effects analysis._
