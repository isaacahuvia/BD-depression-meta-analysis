---
title: "3_Analysis"
output: html_document
---

```{r, message = F, warning = F}
## Startup
rm(list = ls())
library(easypackages)
libraries("tidyverse", "metafor", "magrittr", "knitr")


## Load Data
df <- readRDS("C:\\Users\\isaac\\Google Drive\\Research\\Projects\\Body Dissatisfaction Meta-Analysis\\BD-depression-meta-analysis\\Data\\Data With Effect Sizes.rds")


## Prepare Follow-up Data
#Reshape to long dataset, code for follow-up time-point, and keep only follow-up outcomes
df.fu <- df %>%
        select_at(vars(-matches(".post"))) %>%
        pivot_longer(cols = time.fu1:varG.fu2_t2,
                     names_to = c("var", "followUp"),
                     names_sep = "\\.") %>%
        mutate(var = if_else(var %in% c("d", "varD", "g", "varG"),
                             paste0(var, ".fu", gsub(".*(?=_)", "", followUp, perl = T)),
                             var),
               followUp = gsub("_.*", "", followUp)) %>%
        pivot_wider(names_from = "var",
                    values_from = "value") %>%
        drop_na(time) %>%
        mutate(effectLabel = paste0(effectLabel, " (", time, " weeks)"))
```

# Meta-analysis

Mixed-effects model with robust variance estimation using `metafor`

Reference: <https://www.metafor-project.org/doku.php/analyses>

Documentation: <https://www.rdocumentation.org/packages/metafor/versions/2.4-0/topics/rma.mv> _(see for ANOVA/Wald tests)_

## Post-test effects

### Intercept-only model

#### POST-TEST DATA ONLY

```{r}
model.post.IO_t2 <- rma.mv(yi = g.post_t2 ~ 1,
                           V = varG.post_t2,
                           random = ~ 1 | studyID,
                           data = df) %>%
  robust(cluster = df$studyID)

print(model.post.IO_t2)
```

Default forest plot

```{r}
forest(model.post.IO_t2)
```

My forest plot

```{r}
df$i <- as.factor(1:nrow(df))
df$lower <- df$g.post_t2 - (1.96 * sqrt(df$varG.post_t2))
df$upper <- df$g.post_t2 + (1.96 * sqrt(df$varG.post_t2))

ggplot(df, aes(y = i, 
               x = g.post_t2,
               xmin = lower,
               xmax = upper)) +
        geom_point() +
        geom_errorbarh() +
        scale_y_discrete(label = df$effectLabel) +
        facet_grid(article ~ .,
                   scales = "free_y",
                   space = "free_y",
                   switch = "y") +
        theme(strip.placement = "outside")
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.post.IO_t1t2 <- rma.mv(yi = g.post_t1t2 ~ 1,
                             V = varG.post_t1t2,
                             random = ~ 1 | studyID,
                             data = df) %>%
  robust(cluster = df$studyID)

print(model.post.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

```{r}
count(df, interventionType)

model.interventionType <- rma.mv(yi = g.fu_t2 ~ 1 + factor(interventionType),
                                 V = varG.fu_t2,
                                 random = ~ 1 | studyID,
                                 data = df.fu) %>%
  robust(cluster = df.fu$studyID)

print(model.interventionType)
anova.rma(model.interventionType)
```

_End of post-test effects analysis._

## Follow-up effects

### Intercept-only model

#### FOLLOW-UP DATA ONLY

```{r}
model.fu.IO_t2 <- rma.mv(yi = g.fu_t2 ~ 1,
                         V = varG.fu_t2,
                         random = ~ 1 | studyID,
                         data = df.fu) %>%
  robust(cluster = df.fu$studyID)

print(model.fu.IO_t2)
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.fu.IO_t1t2 <- rma.mv(yi = g.fu_t1t2 ~ 1,
                           V = varG.fu_t1t2,
                           random = ~ 1 | studyID,
                           data = df.fu) %>%
  robust(cluster = df.fu$studyID)

print(model.fu.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

```{r}

```

_End of follow-up effects analysis._
