---
title: "3_Analysis (Old - Robumeta)"
output: html_document
---

```{r, message = F, warning = F}
## Startup
rm(list = ls())
library(easypackages)
libraries("tidyverse", "robumeta", "magrittr", "knitr")


## Load Data
df <- readRDS("C:\\Users\\isaac\\Google Drive\\Research\\Projects\\Body Dissatisfaction Meta-Analysis\\BD-depression-meta-analysis\\Data\\Data With Effect Sizes.rds")


## Prepare Follow-up Data
#Reshape to long dataset, code for follow-up time-point, and keep only follow-up outcomes
df.fu <- df %>%
        select_at(vars(-matches(".post"))) %>%
        pivot_longer(cols = time.fu1:varG.fu2_t2,
                     names_to = c("var", "followUp"),
                     names_sep = "\\.") %>%
        mutate(var = if_else(var %in% c("d", "varD", "g", "varG"),
                             paste0(var, ".fu", gsub(".*(?=_)", "", followUp, perl = T)),
                             var),
               followUp = gsub("_.*", "", followUp)) %>%
        pivot_wider(names_from = "var",
                    values_from = "value") %>%
        drop_na(time) %>%
        mutate(effectLabel = paste0(effectLabel, " (", time, " weeks)"))
```

# Meta-analysis


Meta-analysis is conducted using robuse variance estimation (RVE) methods with `robumeta` <https://cran.r-project.org/web/packages/robumeta/vignettes/robumetaVignette.pdf>. See also Hedges, L. V., Tipton, E., & Johnson, M. C. (2010). Robust variance estimation in meta‚Äêregression with dependent effect size estimates. Research synthesis methods, 1(1), 39-65.

## Post-test effects

### Intercept-only model

#### POST-TEST DATA ONLY

```{r}
#Robu
model.post.IO_t2 <- robu(formula = g.post_t2 ~ 1, 
                 data = df, 
                 studynum = studyID, 
                 var.eff.size = varG.post_t2, 
                 rho = .8,
                 small = T)

print(model.post.IO_t2)
sensitivity(model.post.IO_t2)
```

```{r,  fig.width = 12, fig.height = 12}
forest.robu(model.post.IO_t2,
            es.lab = "effectLabel",
            study.lab = "article")
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.post.IO_t1t2 <- robu(formula = g.post_t1t2 ~ 1,
                           data = df,
                           studynum = studyID,
                           var.eff.size = varG.post_t1t2,
                           rho = .8,
                           small = T)

print(model.post.IO_t1t2)
sensitivity(model.post.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

```{r}

```

_End of post-test effects analysis._

## Follow-up effects

### Intercept-only model

#### FOLLOW-UP DATA ONLY

```{r}
model.fu.IO_t2 <- robu(formula = g.fu_t2 ~ 1, 
                 data = df.fu, 
                 studynum = studyID, 
                 var.eff.size = varG.fu_t2, 
                 rho = .8,
                 small = T)

print(model.fu.IO_t2)
sensitivity(model.fu.IO_t2)
```

```{r,  fig.width = 12, fig.height = 12}
forest.robu(model.fu.IO_t2,
            es.lab = "effectLabel",
            study.lab = "article")
```

#### USING PRE- AND POST-TEST DATA

```{r}
model.fu.IO_t1t2 <- robu(formula = g.fu_t1t2 ~ 1,
                           data = df.fu,
                           studynum = studyID,
                           var.eff.size = varG.fu_t1t2,
                           rho = .8,
                           small = T)

print(model.fu.IO_t1t2)
sensitivity(model.fu.IO_t1t2)
```

### Moderation tests

Moderation tests for each of the following variables (pre-registered) with n >= 3 studies (not effect sizes) per group.

```{r}

```

_End of follow-up effects analysis._
