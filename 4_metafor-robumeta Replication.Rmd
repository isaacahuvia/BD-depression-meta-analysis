---
title: "4_metafor-robumeta Replication"
output: html_document
---

```{r, message = F, warning = F}
## Startup
rm(list = ls())
library(easypackages)
libraries("tidyverse", "robumeta", "metafor", "magrittr", "knitr")


## Load Data
df <- readRDS("C:\\Users\\isaac\\Google Drive\\Research\\Projects\\Body Dissatisfaction Meta-Analysis\\BD-depression-meta-analysis\\Data\\Data With Effect Sizes.rds")
```

# Meta-analysis

## `robumeta`

Robust variance estimation (RVE) methods using `robumeta`. `robu` can
be used to estimate correlated and hierarchical effects models using the original (Hedges, Tipton
and Johnson, 2010) and small-sample corrected (Tipton, 2013) RVE methods. Here "correlated" and "hierarchical" appear to refer to weighting schemes.

Hedges, L. V., Tipton, E., & Johnson, M. C. (2010). Robust variance estimation in meta‐regression with dependent effect size estimates. Research synthesis methods, 1(1), 39-65.

Vignette: <https://cran.r-project.org/web/packages/robumeta/vignettes/robumetaVignette.pdf>

Documentation: <https://cran.r-project.org/web/packages/robumeta/robumeta.pdf>

### `robumeta::robu` model

With correlated weighting

```{r}
model.r <- robu(formula = g.post_t2 ~ 1, 
                data = df, 
                studynum = studyID, 
                var.eff.size = varG.post_t2, 
                rho = .8,
                modelWeights = "CORR",
                small = T)

print(model.r)
```

With hierarchical weighting

```{r}
model.r <- robu(formula = g.post_t2 ~ 1, 
                data = df, 
                studynum = studyID, 
                var.eff.size = varG.post_t2, 
                rho = .8,
                modelWeights = "HIER",
                small = T)

print(model.r)
```

## `metafor`

Mixed-effects model with robust variance estimation using `metafor`. This is a _mixed effects model_.

Reference: <https://www.metafor-project.org/doku.php/analyses>

Documentation: <https://www.rdocumentation.org/packages/metafor/versions/2.4-0/topics/rma.mv> _(see for ANOVA/Wald tests)_

See citations for Konstantopoulos (2011) and Nakagawa and Santos (2012)

Additional reference: <https://wviechtb.github.io/metafor/reference/rma.mv.html>

Additional tutorial: <https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/fitting-a-three-level-model.html>

On difference between `metafor` and `robumeta`: <https://stat.ethz.ch/pipermail/r-sig-meta-analysis/2017-September/000223.html>

See also: <https://cran.r-project.org/web/packages/clubSandwich/vignettes/meta-analysis-with-CRVE.html>

### `metafor::rma.mv` model

```{r}
model.m <- rma.mv(yi = g.post_t2 ~ 1,
                  V = varG.post_t2,
                  random = ~ 1 | studyID,
                  data = df) %>%
  robust(cluster = df$studyID)

print(model.m)
```

### Other `metafor` specifications

```{r}
df <- df %>%
  group_by(studyID) %>%
  mutate(k = n(),
         i = seq(1, n(), 1),
         varG.post_t2_mean = mean(varG.post_t2)) %>%
  ungroup()
```

#### No random effects/clustering

```{r}
rma.mv(yi = g.post_t2 ~ 1,
       V = varG.post_t2,
       data = df)
```

```{r}
rma.mv(yi = g.post_t2,
       V = varG.post_t2,
       data = df)
```

#### No random effects/grouping, but weighting starts to account for clusters

```{r}
rma.mv(yi = g.post_t2 ~ 1,
       V = varG.post_t2,
       W = k / (varG.post_t2_mean),
       data = df)
```

#### Random effects

```{r}
rma.mv(yi = g.post_t2 ~ 1,
       V = varG.post_t2,
       random = ~ 1 | studyID,
       data = df)
```

#### Random effects with robust errors

```{r}
rma.mv(yi = g.post_t2 ~ 1,
       V = varG.post_t2,
       random = ~ 1 | studyID,
       data = df) %>%
  robust(cluster = df$studyID)
```

#### Random effects (3-level) with robust errors

```{r}
rma.mv(yi = g.post_t2 ~ 1,
       V = varG.post_t2,
       random = ~ 1 | studyID/i,
       data = df) %>%
  robust(cluster = df$studyID)
```

#### Moderator and Wald-type test

```{r}
anova.rma(model.m)

model.m.mod <- rma.mv(yi = g.post_t2 ~ 1 + controlCond,
                      V = varG.post_t2,
                      random = ~ 1 | studyID,
                      data = df) %>%
  robust(cluster = df$studyID)

print(model.m.mod)
anova.rma(model.m.mod)
```

Another way to specify moderators

```{r}
rma.mv(yi = g.post_t2,
       mods = ~ controlCond,
       V = varG.post_t2,
       random = ~ 1 | studyID,
       data = df) %>%
  robust(cluster = df$studyID)
```

Now with the moderator as a random variable as well... or is this a weird "inner-outer" thing?

```{r}
rma.mv(yi = g.post_t2 ~ 1 + controlCond,
       V = varG.post_t2,
       random = ~ 1 + controlCond | studyID,
       data = df) %>%
  robust(cluster = df$studyID)
```

```{r}
rma.mv(yi = g.post_t2,
       mods = ~ controlCond,
       V = varG.post_t2,
       random = ~ 1 + controlCond | studyID,
       data = df) %>%
  robust(cluster = df$studyID)
```

